name: Publish to ClawHub

on:
  push:
    tags:
      - 'v*'  # Triggers on v1.0.0, v1.2.3, etc.

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ClawHub CLI
        run: npm install -g clawhub

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog from tag message
        id: changelog
        run: |
          # Get the tag annotation message (if annotated tag)
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${GITHUB_REF#refs/tags/} 2>/dev/null || echo "")
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE="Release ${{ steps.version.outputs.VERSION }}"
          fi
          # Escape for GitHub Actions
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish to ClawHub
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        run: |
          clawhub login --token "$CLAWHUB_TOKEN" --no-browser
          clawhub publish . \
            --slug coder-workspaces \
            --name "Coder Workspaces" \
            --version "${{ steps.version.outputs.VERSION }}" \
            --changelog "${{ steps.changelog.outputs.CHANGELOG }}"

      - name: Summary
        run: |
          echo "## âœ… Published to ClawHub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Skill:** coder-workspaces" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **View:** https://clawhub.ai/skills/coder-workspaces" >> $GITHUB_STEP_SUMMARY
